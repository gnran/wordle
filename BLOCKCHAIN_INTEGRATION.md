# Интеграция с блокчейном - Инструкция

## Установка зависимостей

Установите ethers.js для работы с контрактом:

```bash
npm install ethers@^6.0.0
```

## Настройка контракта

1. Разверните контракт в сети Base (см. `C:\VibeCoding\Wordle-Contracts\DEPLOYMENT.md`)

2. Обновите конфигурацию в `src/config/contract.ts`:
   - Установите `CONTRACT_ADDRESS` на адрес развернутого контракта
   - Установите `CONTRACT_CHAIN_ID`:
     - `84532` для Base Sepolia (тестовая сеть)
     - `8453` для Base Mainnet

## Как это работает

### Логика работы

1. **Локальное хранение**: Статистика игрока хранится в `localStorage`
2. **Отправка в блокчейн**: При нажатии "Submit stats onchain":
   - Вычисляется дельта между текущей статистикой и последней отправленной
   - Отправляется только разница (deltaWins, deltaLosses)
   - Используется nonce для защиты от replay-атак
3. **Хранение lastSubmitted**: После успешной отправки сохраняется информация о последней отправке в `localStorage`

### Структура данных

**Локальная статистика** (`localStorage: wordle-stats`):
```json
{
  "totalGames": 42,
  "wins": 27,
  "losses": 15,
  "winPercentage": 64.3,
  "currentStreak": 3,
  "maxStreak": 5
}
```

**Последняя отправка** (`localStorage: wordle-last-submitted`):
```json
{
  "games": 30,
  "wins": 18,
  "losses": 12,
  "nonce": 1,
  "txHash": "0x...",
  "timestamp": 1234567890
}
```

### Вычисление дельты

При отправке вычисляется:
- `deltaWins = localStats.wins - lastSubmitted.wins`
- `deltaLosses = localStats.losses - lastSubmitted.losses`
- `expectedNonce = lastSubmitted.nonce`

Если `lastSubmitted` отсутствует (первая отправка):
- `deltaWins = localStats.wins`
- `deltaLosses = localStats.losses`
- `expectedNonce = 0`

## Функционал

### Кнопка "Submit stats onchain"

- Отображается только если подключен кошелек
- Неактивна, если нет игр (totalGames === 0)
- Показывает индикатор загрузки во время отправки
- Отображает ошибки или успешные сообщения

### Обработка ошибок

- **Нет кошелька**: Показывается предупреждение
- **Неправильная сеть**: Автоматическое переключение на Base
- **Неверный nonce**: Требуется обновление страницы
- **Отклонение транзакции**: Информативное сообщение
- **Ошибки сети**: Сообщение с инструкциями

## Тестирование

1. Разверните контракт на Base Sepolia (тестовая сеть)
2. Обновите `CONTRACT_ADDRESS` и `CONTRACT_CHAIN_ID` в `src/config/contract.ts`
3. Запустите приложение: `npm run dev`
4. Сыграйте несколько игр
5. Откройте профиль и нажмите "Submit stats onchain"
6. Подтвердите транзакцию в кошельке
7. Проверьте транзакцию на BaseScan

## Важные замечания

1. **Nonce**: Каждая успешная транзакция увеличивает nonce. Если nonce не совпадает, нужно обновить страницу.

2. **Сброс статистики**: При сбросе статистики через "Сбросить статистику" также очищается `lastSubmitted`.

3. **Батчи**: Максимум 200 игр за одну транзакцию. Если накопилось больше, нужно отправлять несколько раз.

4. **Газ**: Пользователь платит за газ из своего кошелька. Убедитесь, что у пользователя есть ETH на Base.

5. **Безопасность**: Контракт не проверяет корректность игровых данных. Пользователь может отправлять любые данные, но не может уменьшить или перезаписать уже отправленную статистику.

## Troubleshooting

### "Кошелек не подключен"
- Убедитесь, что пользователь подключил кошелек через Farcaster SDK
- Проверьте, что `userInfo.walletAddress` не пустой

### "Неправильная сеть"
- Приложение автоматически попытается переключить сеть
- Если не получается, пользователь должен вручную переключиться на Base в кошельке

### "Неверный nonce"
- Обновите страницу
- Проверьте, что `lastSubmitted` в localStorage соответствует реальному nonce в контракте

### Транзакция зависла
- Проверьте статус транзакции на BaseScan
- Если транзакция не подтвердилась, можно попробовать снова (nonce не изменится, если транзакция не прошла)
